# Ch10. 알림 시스템 설계

- 최신 뉴스, 제품 업데이트, 이벤트, 선물 등 고객에게 중요할만한 정보를 비동기적으로 제공

## 문제 이해 및 설계 범위 확정

- 푸시 알림, SMS 메세지, 이메일 지원해야함.

- 연성 실시간 시스템 (Soft Real-time)이라 가정. 알림은 가능한한 빨리 전달되어야 하지만 시스템에 높은 부하가 걸렸을 때 약간의 지연은 무방하다.

- 모바일 (IOS, Android, 랩톱/데스크톱) 지원해야함.

- 클라이언트 & 서버 모두 알림 만들 수 있어야함.

- 사용자가 알림 받지 않게 설정할 수 있어야함.

- 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야함.

## 개략적 설계안 제시 및 동의 구하기

### 알림 유형별 지원 방안

- IOS 푸시 알림

  - APNS (Apple Push Notification Service)
    - 단말 토큰(device token)
    - 페이로드(payload)

- Android : FCM(Firebase Cloud Messaging)

- SMS 메시지 : 트윌리오, 넥스모

- 이메일 : 센드그리드, 메일침프

### 연락처 정보 수집 절차

- 모바일 단말 토큰, 전화번호, 이메일 등 정보를 수집하는데, 앱을 설치하거나 계정 등록할 때 사용자 정보 수집해서 DB에 저장.

- 설계 시점에 한 사용자가 여러 디바이스를 소유하고 있는 것도 감안해야함.

### 알림 전송 및 수신 절차

- 개략적 설계안 확인 후, 최적화 예정

#### 개략적 설계 초안

- 1 ~ N 까지 서비스 : 온갖 서비스들이 알림을 필요로함 (과금 안내 서비스, 배송 알림 등...)

- 알림 시스템: 우선 1개 서버만 사용한다고 가정. 서비스 1 ~ N개에 알림 전송을 위한 API가 필요하고, 제 3자 서비스에 전달할 알림 페이로드(Payload)가 필요하다.

- 제 3자 서비스: 사용자들에게 실제로 알림을 전달하는 역할. 새로운 서비스 통합 또는 기존 서비스 제거할 수 있어야함.

- 문제점 : SPOF, 규모 확장성 (단일 서버에서 처리하므로 DB or Cache 등 중요 컴포넌트 규모를 개별적으로 늘릴 방법이 없음.), 성능 병목

![System Design Draft](https://github.com/ttlqudan/WoowahanStudy/assets/40455392/481f08b3-370a-4d9e-ad1f-177f65777fee)

#### 개략적 설계안 개선된 버전

- DB & Cache를 알림 시스템의 주 서버에서 분리

- 알림 서버 증설하고 자동으로 스케일 아웃할 수 있게 설정

- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊음.

![System Design Revisioned](https://github.com/ttlqudan/WoowahanStudy/assets/40455392/d8cc165b-122b-4ccb-82ca-001f0e645ee7)

- 추가로 알림 서버는 아래 기능을 제공해야함

  - 알림 전송 API : 사내 서비스 또는 인증된 클라이언트만 사용

  - 알림 검증(validation) : 이메일 주소, 전화번호 등 기본 정보 검증

  - DB or Cache query : 알림에 포함시킬 데이터 가져오는 기능

  - 알림 전송 : 알림 데이터를 메시지 큐에 넣고 병럴 처리

- 호출 순서

  - API를 호출해서 알림 서버로 알림을 보낸다.

  - 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타 데이터를 캐시나 데이터베이스에서 가져옴.

  - 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐에 넣음. 가련 IOS 푸시 알림 이벤트는 IOS 푸시 알림 큐에 넣는다.

  - 작업 서버는 메시지 큐에 알림 이벤트를 꺼낸다.

  - 작업 서버는 알림을 제 3자 서비스로 보낸다.

  - 제3자 서비스는 사용자 단말로 알림을 전송한다.

## 상세 설계

- 안정성(reliability) : 데이터 손실 방지 (AWS SQS Dead Letter Queue), 알림 중복 전송 방지 (이벤트 ID 검사해서 이전에 본 적 있는 이벤트인지 체크),

- 추가로 필요한 컴포넌트 및 고려사항 : 알림 템플릿, 알림 설정, 전송율 제한, 재시도 메커니즘, 보안, 큐에 관한 알림 등...

  - 알림 템플릿 : 매번 알림 메시지를 처음부터 만들 필요가 없음.

  - 알림 설정 : 알림을 상세히 조정할 수 있어야함.

  - 전송율 제한 : 한 사용자가 받을 수 있는 알림 빈도 제한.

  - 재시도 방법 : 서비스가 알림 전송 실패하면, 해당 알림을 재시도 전용 큐에 넣는다. 같은 문제 지속되면 개발자에게 통지(alert)

  - 푸시 알림과 보안 : 인증 혹은 승인된 클라이언트만 API 사용해서 알림 보낼 수 있어야함.

  - 큐 모니터링 : 모니터링할 때 중요한 지표 중 하나는 큐에 쌓인 알림 갯수. 이 수가 많으면 서버가 이벤트 처리를 빨리 못한다는 것.

  - 이벤트 추적 : 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율같은 지표는 사용자를 이해하는데 중요함.

- 개선된 설계안

![Revisioned Architecture](https://github.com/ttlqudan/WoowahanStudy/assets/40455392/a2857654-2f82-45aa-8329-e87a8647d048)
