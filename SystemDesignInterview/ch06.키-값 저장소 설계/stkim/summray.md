# Ch 06. 키-값 저장소 설계

## 문제의 이해 범위 설정

- 키-값의 크기는 10kb 이하다.

- 큰 데이터를 저장할 수 있어야함.

- 높은 가용성을 제공해야함.

- 높은 규모 확장성을 제공해야함

- 데이터 일관성 수준은 조정 가능해야함

- 응답 지연시간이 짧아야함.

## 단일 키-값 저장소

- 가장 직관적인 것은 키-값 쌍 전부를 메모리 해시 테이블에 저장하는 것.

- 그러나 메모리 용량 한계상 모든 키-값을 저장하는 것은 불가능함.

  - 대안

    - 데이터 압축
    - 자주쓰는 데이터만 메모리에 올리고 나머지는 데이터에 저장

## 분산 키-값 저장소

- CAP 정리는 데이터 일관성 (Consistency), 가용성(Availability), 파티션 감내(Partition Tolerance) 세 요구 사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리.

  - 데이터 일관성 : 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계 없이 언제나 같은 데이터를 보게 되어야함.

  - 가용성 : 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야함.

  - 파티션 감내 : 파티션은 두 노드 사이에 통신 장애가 발생했음을 듯함. 파티션 감내는 네트워크에 파티션이 발생해도 시스템은 계속 동작해야함.

![CAP 정리](https://github.com/ttlqudan/WoowahanStudy/assets/40455392/8d63c2a1-18b1-47f3-885c-18317579a34f)

- CA 시스템 : 일관성과 파티션 감내를 지원하는 키-값 저장소. 가용성을 희생

- AP 시스템 : 가용성과 파티션을 감내를 지원하는 키-값 저장소. 데이터 일관성을 희생

- CA 시스템 : 일관성과 가용성을 지원하는 키-값 저장소. 파티션 감내는 지원하지 않는다. 그러나 통상 네트워크 장애는 피할 수 없는 일로 여기므로, 분산 시스템에서 반드시 파티션 문제를 감내하게 설계되어야함. 그러므로 현실에서 CA 시스템은 존재하지 않음.

### 이상적 상태

- 네트워크가 파티션 상태가 발생하지 않는 것.

### 실제 분산 시스템

- 파티션 문제를 피할 수 없음.

### 시스템 컴포넌트

- 키-값 저장소 구현의 핵심 컴포넌트

  - 데이터 파티션
  - 데이터 다중화 (replication)
  - 일관성 (consistency)
  - 일관성 불일치 해소 (inconsistency resolution)
  - 장애 처리
  - 시스템 아키텍처 다이어그램
  - 쓰기 경로 (Write Path)
  - 읽기 경로 (Read Path)

- 안정 해시를 사용해서 데이터 파티션을 하면 좋은 점

  - 규모 확장 자동화 : 시스템 부하에 따라 서버가 자동으로 추가 또는 삭제가 되어야함

  - 다양성 : 각 서버의 용량에 맞게 가상 노드의 수를 조정할 수 있음.

### 데이터 일관성

- 정족수 합의 프로토콜 사용하면 읽기/쓰기 연산 모두에 일관성을 보장할 수 있음

#### 일관성 모델

- 강한 일관성

- 약한 일관성

- 최종 일관성

#### 비일관성 해소 방법 : 데이터 버저닝

- 버저닝(Versioning)

- 벡터 시계 (Vector Clock)
