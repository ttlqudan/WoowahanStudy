# Ch08. url 단축기 설계

## 요구사항

- URL 단축 : 주어진 긴 url을 짧게 줄임
- URL 리디렉션 : 축약된 url로 http 요청이 오면 원래 url로 안내
- 높은 가용성과 규모 확장성, 그리고 장애 감내가 요구됨.

## 개략적 추정

- 쓰기 연산 : 매일 1억개의 단축 URL 생성
- 초당 쓰기 연산 : 1억(100Million) / 24 / 3600 = 1160
- 읽기 연산 : 읽기 연산과 쓰기 연산 비율은 10:1이라 가정. 그 경우 읽기 연산은 초당 11,600회 발생
- URL 단축 서비스 10년 운영시 1억 x 365 x 10 = 3650억개의 레코드 보관 필요.
- 축약전 url 평균 길이는 100자라 가정
- 따라서 10년 동안 필요한 저쟝 용량은 3650억 x 100바이트 = 36.5TB임.

## 개략적 설계안 제시 및 동의 구하기

### 1. API Endpoint

- 클라이언트와의 통신은 API endpoint를 사용한다.

  - URL 단축용 엔드포인트
  - URL 디렉션용 엔드 포인트

### 2. URL Redirection

- 단축 url을 받은 서버는 그 url을 원래 url로 바꿔 301 응답의 Location 헤더에 넣어 반환한다.

  - 유의 사항
    - 301 Permanently Moved: 해당 url에 대한 http 요청의 처리 책임이 영구적으로 location 헤더에 반환된 url로 이전되었다는 응답임. 서버 부하를 줄일 때 유리함. (첫번째 요청만 단축 url 서버로 전송될 것이기 때문.)
    - 302 Found: 일시적으로 location 헤더가 지정하는 url에 의해 처리한다는 응답. 트래픽 분석, 클릭 발생율, 발생 위치 등 추적하는데 유리함.

- url redirection 구현에 가장 직관적인 방법은 해시 테이블을 사용하는 것임.

  - 구현 예시
    - 원래 url = 단축 url
    - 301 or 302 응답 location 헤더에 원래 url 넣고 전송.

### 3. URL 단축

- 입력으로 주어진 긴 url이 다른 값이면 해시도 달라져야함.
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 url로 복원될 수 있어야함.

## 상세 설계

- 해시 테이블 사용이 초기 전략으론 괜찮지만 실제 시스템에 사용이 어려움. 메모리는 유한하고 비쌈.

- RDBMS에 <단축 url, 원래 url> 쌍으로 저장하는 것이 좋음.

- 해시 함수는 원래 url을 단축 url로 변환하는데 사용됨.

- 사용할 수 있는 문자 갯수는 62개임. [1-9,a-z,A-Z] 10+26+26

- 즉, 62^n >= 3650억인 n 최솟값을 찾아야함. n이 7이면 3.5조이므로 hashValue 길이는 7로 지정.

  - 잘 알려진 해시 함수 : CRC32, MD5, SHA-1

  - 문제는 이들을 사용하면 가장 짧은 해시도 7자보다 길다.

    - 해결 방법으론 충돌 해소가 될 때까지 사전에 정한 문자열을 해시값이 붙인다.

      - 문제 : DB에 쿼리를 보내므로 오버헤드가 발생함.

      - 해결법 : Base-62 기반 접근. 수의 표현 방식이 다른 두 시스템이 같은 수를 공유하는 경우 유용함. 62진법 사용 이유는 문자 갯수와 동일함.

## 마무리

- 처리율 제한 장치

- 웹 서버 규모 확장

- 데이터베이스 규모 확장

- 데이터 분석 솔루션

- 가용성, 데이터 일관성, 안정성
