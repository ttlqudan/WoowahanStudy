# Ch11. 뉴스 피드 시스템 설계

## 1단계 : 문제 이해 및 설계 범위 확정

- 멀티 디바이스 지원 필요함.

- 사용자는 뉴스 피드 페이지에 새로운 스토리를 올릴 수 있어야하고, 친구들이 올리는 스토리를 볼 수도 있어야함.

- 피드 노출 순서는 설계 상 단순하게 시간 흐름 역순으로 표기

- 한 명의 사용자는 최대 몇 명의 친구를 가질 수 있는가? -> 5000명

- 트래픽은 DAU 천만 명(10 Million)

- 스토리에 이미지나 비디오 등의 미디어 파일 포함 가능함.

## 2단계 : 개략적 설계안 제시 및 동의 구하기

- 피드 발행: 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록. 새 포스팅은 친구의 뉴스 피드에도 전송.

- 뉴스 피드 생성: 지면 관계상 뉴스 피드는 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다고 가정.

### 뉴스 피드 API

- 뉴스 피드 API는 클라이언트가 서버와 통신하기 위해 사용하는 수단

- HTTP 프로토콜 기반, 상태 정보 업데이트 및 뉴스 피드 가져오기, 친구 추가 등 다양한 작업 수행에 사용.

#### 피드 발행 API

- `POST /v1/me/feed`

#### 피드 읽기 API

- `GET /v1/me/feed`

### 피드 발행

- 사용자

- 로드 밸런서

- 웹 서버

- 포스팅 저장 서비스

- 포스팅 전송 서비스 : 새 포스팅을 친구의 뉴스 피드에 푸시(push)

- 알림 서비스

### 뉴스 피드 생성

- 사용자

- 로드밸런서

- 웹 서버

- 뉴스 피드 서비스

- 뉴스 피드 캐시

## 3단계 : 상셰 설계

### 피드 발행 흐름 상세 설계

1. 웹서버 : 웹 서버는 클라이언트 통신 뿐만 아니라 인증이나 처리율 제한 등의 기능도 수행. 올바른 인증 토큰을 갖고 API 호출하는 사용자만 포스팅 할 수 있어야하고, 유해 컨텐츠 자주 올라오는 것 방지를 위해 특정 기간 동안 사용자의 포스팅 수 제한 해야함.

2. 포스팅 전송(팬아웃) 서비스 : 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정. 2가지 모델 존재

- 쓰기 시점 팬아웃(fanout-on-write, 푸시 모델) : 새로운 포스팅 기록 시점에 뉴스 피드 갱신. 다시 말해, 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅 기록

  - 장점

    - 실시간 갱신 및 친구 목록 사용자에게 즉시 전송

    - 뉴스 피드 읽는 시간 짧아짐.

  - 단점

    - 핫키(hotkey) 이슈 존재. 친구가 많으면 사용자 모두의 뉴스 피드 갱신에 시간 많이 소요됨.

    - 서비스를 자주 이용하지 않는 사용자 피드까지 갱신 되므로 컴퓨팅 자원 낭비됨

- 읽기 시점 팬아웃(fanout-on-read, on-demand 모델) : 사용자가 본인 홈페이지 또는 타임 라인 로딩 시점에 새로운 포스트 가져옴.

  - 장점

    - 비활성 및 서비스 로그인을 거의 안하는 사용자의 경우 유리함. 로그인하기 전까지 어떤 컴퓨팅 자원도 소요되지 않음.

    - 핫키 문제 없음

  - 단점

    - 뉴스 피드 읽는데 많은 시간 소요될 수 있음. (request 시점이 batch update 되는 시점이므로)

- 본 설계에서는 대부분의 사용자에 대해서는 푸시 모델을 사용하고, 안정 해시를 사용해서 요청과 데이터를 보다 고르게 분산하여 핫키 문제를 줄여볼 것

- 팬아웃 서비스 동작 로직

  - 그래프 DB를 사용해서 친구 관계나 친구 추천 관리

  - 사용자 정보 캐시에서 친구 정보 가져옴. 사용자 설정에 따라 친구 가운데 일부 필터.

  - 친구 목록과 새 스토리의 포스팅 ID를 메세지 큐에 넣는다.

  - 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내 뉴스 피드 데이터를 뉴스 피드 캐시에 넣고, `<포스팅 ID, 사용자 ID>` 의 순서쌍을 보관하는 매핑 테이블로 관리.

    - 너무 많은 정보를 매핑 테이블에 넣으면 메모리 요구량이 늘어나니 주의 필요.

### 피드 읽기 흐름 상세 설계

- 사용자가 뉴스 피드 읽으려는 요청 보냄. `/v1/me/feed`로 전송

- 로드 밸런서가 요청을 웹 서버 가운데 하나로 보냄

- 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스를 호출

- 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록 가져옴

- 뉴스 피드에 표기할 사용자 이름, 사용자 사진, 포스팅 콘텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 가져와 완전한 뉴스 피드 만듦

- 생성된 뉴스 피드를 JSON 형태로 클라이언트에 보냄. 클라이언트는 해당 피드 렌더링

### 캐시 구조

- 뉴스 피드

- 콘텐츠

- 소셜 그래프

- 행동

- 횟수

## 4단계 : 마무리

### 더 논의해 볼 주제들

1. 데이터베이스 규모 확장

- 수직 vs 수평 규모 확장

- SQL vs NoSQL

- 주-부(master-slave) 다중화

- 복제본에 대한 읽기 연산

- 일관성 모델

- 데이터베이스 샤딩

2. 그 외의 논의해 볼 주제들

- 웹 계층 무상태로 운영

- 가능한 한 많은 데이터 캐싱 방법

- 여러 데이터 센터 지원 방법

- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기

- 핵심 메트릭(key metric)에 대한 모니터링
