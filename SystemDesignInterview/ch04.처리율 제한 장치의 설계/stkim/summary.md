# Ch04. 처리율 제한 장치의 설계

- 네트워크 시스템에서 처리율 제한 장치 (rate limiter)는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치다.

- HTTP로 예를 들면, 이 장치는 특정 기간 내에 전송되는 클라이언트의 요청 횟수를 제한한다.

- 처리율 제한 장치 설계 시, 좋은 점.

  - DoS 공격에 의한 자원 고갈 방지.

    - 트위터는 3시간 동안 300개 트윗만 올리게 제한

    - 구글 독스 API는 사용자당 분당 300회의 Read 요청 허용.

    - 예시
      - Github Action으로 외부 API 호출 횟수가 일정 범위 넘어가면 Action에서 Too Many Request (429) 처리
      - Poetry로 버전관리할 때 이슈 발생함.
        - 의존성 찾기 위해 계속 API 요청함.

  - 비용 절감 : 서드 파티 api 사용료

    - 예시 : 주식 시장에서 미국 주식 데이터를 핸들링하는 Refinitive에서는 분당 3회까지 데이터 요청 제한하고, 업체 당 API 쿼터 제한으로 계약함.

  - 서버 과부하를 막음. 봇에서 오는 트래픽이나 잘못된 이용 패턴으로 유발된 트래픽을 걸러냄.

## 개략적 설계안 제시 및 동의 구하기

- 처리율 제한 장치는 어디에 둘 것인가? 클라이언트 vs 서버

  - 클라우드 MSA의 경우, 처리율 제한 장치는 보통 API 게이트웨이라는 컴포넌트에 구현됨.

- 처리율 제한 알고리즘

  - 토큰 버킷
  - 누출 버킷
  - 고정 윈도 카운터
  - 이동 윈도 로그
  - 이동 윈도 카운터

- 개략적 아키텍처 설계

## 상세 설계

- 처리율 제한 규칙

  - 처리율 한도 초과 트래픽 처리 : HTTP 429

- 분산 환경에서 처리율 제한 장치 구현

  - race condition

    - Lua script: https://stripe.com/blog/rate-limiters

    - Sorted set: https://engineering.classdojo.com/blog/2015/02/06/rolling-rate-limiter/

  - synchronization

  - 성능 최적화

  - 모니터링

## 마무리

- 추가로 고려해 볼 부분

  - 경성 또는 연성 처리율 제한

    - 경성(hard) 처리율 제한: 요청 갯수는 임계치를 절대 넘을 수 없음.
    - 연성(soft) 처리율 제한: 요청 갯수는 잠시 동안은 임계치를 넘어설 수 있다.

  - 다양한 계층에서의 처리율 제한

  - 처리율 제한 회피 방법

    - 클라이언트 측 캐시 사용해서 API 호출 횟수 줄임.

    - 처리율 제한 임계치 이해하고, 짧은 시간 동안 너무 많은 메세지를 보내지 않는다.

    - 예외나 에러 처리하는 코드 도입해서 클라이언트가 예외 상황에서 우아하게 복구될 수 있게 한다.

    - 재시도 로직 구현 시, 충분한 백오프 시간 둔다.

## 궁금하거나 물어볼 부분.

- OSI 계층 나눠서 요청 처리율 제한을 해본 경험이 있는지?

  - 보통 방화벽에서 특정 포트 또는 ip, subnet 단위로 요청 대역폭 제한이 가능한 걸로 알고 있음.

- 처리율 제한 로직을 비즈니스 목적에 맞게 직접 구현해서 적용해 본 적이 있는지?

- 연성 처리율 제한 (요청 갯수가 잠시 동안 임계치 넘어서는 상황)이 필요한 케이스가 있었는지?
