# chapter 6. 파티셔닝
- 데이터가 너무 많거나 qps가 너무 높아서 데이터 셋을 쪼개는 것. **샤딩**이라고도 함

### 파티셔닝과 복제
보통 복제와 파티셔닝을 같이 적용해서 각 파티션의 팔로워를 다른 노드에 추가함으로써 내결함성을 보장한다.

### 키-값 데이터 파티셔닝
- 핫스팟: 파티셔닝이 고르지 않아서 특정 파티션에 데이터 혹은 쿼리가 skew된 파티션.

#### 키 범위 기준 파티셔닝
사전처럼 각 파티션에 연속된 범위로 키를 할당하여 파티셔닝. ex) a-c, d-f, ..., x-z
- 키 범위 크기가 반드시 동일할 필요는 없다.
- 파티션 경계는 관리자가 수동으로 선택하거나 데이터베이스에서 자동으로 선택되게 할수 있다.(partition rebalancing)
- 각 파티션 내에서는 키를 정렬된 순서로 저장할 수 있다.
- 특정한 접근 패턴이 핫스팟을 유발하는 단점이 있다. ex) timestamp가 key면, 최신의 time 데이터는 하나의 파티션에서만 write될수 있다. 

#### 키의 해시값 기준 파티셔닝
- 해시 함수를 이용해서 key 분산
- range query 시 모든 파티션에 실행해야 하는 단점이 있다.

#### 쏠린 작업부하와 핫스팟 안화
해시 함수를 쓰더라도, 특정 key에 대한 액세스로 인해 동일한 파티션에 쏠리는 핫스팟 문제가 발생할 수 있다.

이를 해결하기 위한 방법은 핫스팟을 유발하는 key의 prefix or suffix에 임의의 값을 부여해서 여러개의 다른 key로 분산. 다만, Read시 추가적인 작업이 필요하다.  

### 파티셔닝과 보조 색인

#### 문서 기준 보조 색인 파티셔닝
각 파티션마다 secondary index를 관리 (local index)
- 모든 파티션에 질의를 해야하는 문제가 있다. (scatter/gather)

#### 용어 기준 보조 색인 파티셔닝
용어 기준으로 global index를 관리. (term-partitioned)
- Read시 모든 파티션에 scatter/gather 할 필요 없이, 원하는 용어를 포함하는 파티션으로 요청을 보내면 된다.
  - 다만, Write가 복잡. 여러 파티션에 영향을 줄수 있기 때문.

### 파티션 재균형화(rebalancing)
Rebalancing: 클러스터에서 한 노드가 담당하던 부하를 다른 노드로 옮기는 과정

Rebalancing 요구사항
- 부하가 클러스터 내에 있는 노드들 사이에 균등하게 분배되어야 한다.
- 리밸런싱 도중에도 데이터베이스는 읽기, 쓰기 요청을 받아들여야 한다.
- 리밸런싱이 빨리 실행되고 네트워크와 디스크 I/O 부하를 최소화할수 있도록 노드들 사이에 데이터가 필요 이상으로 옮겨져서는 안된다.

#### 재균형화 전략

##### 쓰면 안되는 방법: 해시값에 mod N
- 노드 개수 N이 바뀌면 대부분의 key가 노드 사이에 옮겨져야 한다. 리밸런싱 비용이 너무 커진다.

##### 파티션 개수 고정
- 파티션을 노드 대수보다 많이 만들고 각 노드에 여러 파티션을 할당. 
- 데이터베이스가 처음 구축될 때 파티션 개수가 고정되고 이후에 변하지 않는다.
- ex) 리악, 엘라스틱서치, 카우치베이스, 볼드모트

##### 동적 파티셔닝
키 범위 파티셔닝에서 파티션 경계가 잘못 지정되면 특정 파티션에 데이터가 몰릴 수 있다. 이를 해결하기 위해, 파티션 크기에 임계점을 설정해서 임계점을 넘어가면 파티션을 분리하거나 병합한다.


##### 노드 비례 파티셔닝
- 파티션 개수가 노드 대수에 비례하도록, 노드당 할당되는 파티션 개수를 고정하는 방법. 
- 노드를 늘리면 파티션의 사이즈가 작아진다. 데이터 용량이 커지면 노드도 많이 필요하므로 개별 파티션 크기를 안정적으로 유지할수 있다.

#### 운영: 자동 재균형화와 수동 재균형화
자동 리밸런싱은 유지보수에 손이 덜 가지만, 예측하기 어렵고, 연쇄 장애가 발생할 수 있기 때문에 느리지만 수동으로 하는 것이 좋을 수도 있다.

### 요청 라우팅
서비스 디스커버리의 일종.

##### 라우팅 방법
1. Node layer: 클라이언트가 라운드로빈으로 아무 노드에 접속하고, 해당 파티션이 해당 노드에 있으면 바로 응답, 없으면 올바른 노드로 전달해서 응답을 받고 전달
2. Routing layer: 클라이언트의 모든 요청을 라우팅 계층으로 보내고, 라우팅 계층에서 적합한 노드를 찾아서 전달.
3. Client layer: 클라이언트가 파티셔닝 방법과 파티션이 어떤 노드에 할당됐는지를 알고 있게 하고, 클라이언트가 중개자 없이 스스로 올바른 노드로 접속

#### 병렬 질의 실행
대규모 병렬 처리(massively parallel processing, MPP) 은 10장에서..