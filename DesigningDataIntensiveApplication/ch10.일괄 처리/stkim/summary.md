# Part 3. 파생 데이터

## 들어가기 전에...

- 1, 2부에서는 디스크에 저장된 데이터의 레이아웃부터 결함이 있는 상황에서의 분산된 일관성의 한계까지, 분산 DB로 가기 위한 모든 주요 사항을 밑바닥부터 다룸.

- 1, 2부에서는 단일 DB 사용을 전제로 설명

- 큰 애플리케이션에서는 데이터를 접근하고 처리하는데 다양한 방법이 필요

  - 데이터 스토어, 색인, 캐시, 분석 시스템 등...

- 그래서 3부부턴 데이터 모델도 다르고 최적화된 접근 양식도 다른 여러 데이터 시스템을, 일관성 있는 하나의 애플리케이션 아키텍처로 통합하는 문제를 검토함.

## 레코드 시스템과 파생 데이터 시스템

- 레코드 시스템

  - 믿을 수 있는 데이터 버전 저장. 진실의 근원(source of truth)라고도 부름.

  - 사용자 입력과 같은 새로운 데이터가 들어오면 먼저 레코드 시스템에 저장 후, 정규화를 거쳐 정확하게 한 번 표헌됨.

  - 따라서 레코드 시스템과 다른 시스템 간에 차이가 발생하면 정의에 따라 레코스 시스템이 옳다고 판단함.

- 파생 데이터 시스템

  - 다른 시스템의 데이터를 가져와 특정 방식으로 변환하고 처리한 결과.

  - 파생 데이터는 잃더라도 원본 데이터로부터 다시 데이터를 가져와 생성 가능함.

  - 캐시가 대표적인 예시.

- 엄밀히 말하면 파생 데이터는 기존 데이터를 복제한다는 의미에서 복제(Redundant)에 해당함.

- 파생 데이터는 비정규화를 통해 생성됨. 단일 원천 데이터로부터 여러 데이터셋을 추출해 데이터셋마다 서로 다른 관점으로 데이터를 본다.

# Chapter 10. 일괄 처리

## 1. 들어가기 전에...

- 1, 2부에서 언급한 현대의 데이터 시스템에서 가정하고 있는 데이터 처리 방식은 먼저 시스템에 요청을 하거나 지시를 보낸 후 (요청이 성공하면) 잠시 뒤에 해당 시스템으로부터 결과를 반환 받는 방식.

- 해당 내용의 전제는 **온라인 시스템**은 웹브라우저가 특정 페이지를 요청하는 서비스가 원격 API를 호출하든 일반적으로 사람이 사용자로서 요청을 보내고 응답을 기다리고 가정한다.

  - 이 과정에서 사용자가 오래 기다릴 수 없어서 응답 시간 단축 (latency 줄이기)에 많은 노력을 기울임.

  - 웹과 점점 늘어나는 HTTP/REST 기반의 API 요청/응답 방식이 흔해져서 당연한 것으로 여길 수 있으나, 이 방법이 유일한 방법은 아님.

- HTTP/REST API 방식 외의 데이터 처리 방식

  - 서비스 (온라인 시스템)

    - 클라이언트로부터 요청이나 지시가 올 때까지 기다리다가 ASAP 하게 요청을 처리해서 응답하려고함 -> 즉, 응답 속도는 서비스 성능 측정의 중요한 지표.

  - 일괄 처리 시스템

    - 큰 데이터를 입력 받아 작업 수행 후, 결과 데이터 생산.

    - 반복 주기로 실행

    - 작업 지표로 보는 주요 성능은 **처리량**

  - 스트림 처리 시스템

    - 온라인와 오프라인 처리 어딘가에 있기 때문에 준실시간 처리 (near-real-time processing or nearline processing)이라고 부름.

    - 이벤트 발생 직후에 처리가 실행됨.

    - 성능 지표는 입력 데이터 중 특정 크기만큼 처리할 때 걸리는 시간으로 봄.

- 일괄 처리 알고리즘 맵리듀스(MapReduce)는 구글에서 발표하고, MongoDB, CouchDB 등에 구현됨.

  - DW 용으로 개발된 병렬처리 시스템보다 상당히 저수준 프로그래밍 모델임.

- 10장의 목적 : 맵리듀스와 다른 일괄처리 할고리즘을 보고 현대 데이터 시스템에서 어떻게 사용하는지 알아보자.

## 2. 유닉스 도구로 일괄 처리하기

### 2.1 단순 로그 분석

- 수 기가 바이트의 로그 파일을 수 초 내로 처리 가능하고, 분석 방법 변경이 용이함.

- awk, sed, grep, sort, uniq, xargs 등

- 프로그래밍 언어로 스크립트 작성하는 것도 쉽지만, 둘 중 하나를 선택하는 것은 취향 이슈임.

- 하지만 실행 흐름이 크게 다른 것은 대용량 파일을 분석할 때 확연히 드러남.

- 대표적으로 `sort` 유틸리티는 메모리보다 큰 데이터셋을 읽을 때 자동으로 디스크로 보내서 여러 cpu 코어에 병렬로 정렬함.

  - 즉, 메모리 부족 없이 손쉽게 큰 데이터셋으로 확장 가능함.

### 2.2 유닉스 철학

- 큰 데이터 분석이 용이한 것은 유닉스 설계 철학 중 하나.

- 1987년에 기술된 유닉스 철학

  - 각 프로그램이 한 가지 일만 하도록하라. 기존 프로그램을 고쳐 새로운 기능을 추가해 복잡하게 만드는 것보다 새로운 프로그램 작성을 하자.

  - 모든 프로그램 출력은 아직 알려지지 않은 다른 프로그램 입력으로 쓰일 수 있다고 생각해라. 불필요한 정보 출력으로 너저분해서는 안된다.

  - 소프트웨어를 빠르게 써볼 수 있게 설계하고 구축하라. 수 주 안에 끝내는 게 이상적이고 거슬리는 부분은 과감하게 버리고 새로 구축하라.

  - 프로그래밍 작업을 줄이려면 미숙한 도움보단 도구를 사용하라. 도구 빌드를 위해 한참을 둘러가야하고 게다가 사용 후 바로 버린다 할지라도 도구를 써라.

- 오늘날 Agile & DevOps 방법과 무척 흡사함.

### 2.3 동일 인터페이스

- 어떤 프로그램의 출력을 다른 프로그램의 입력으로 사용하려면 같은 데이터 형식을 사용해야함 -> 즉 같은 인터페이스 사용이 필요하다.

- 유닉스에서 인터페이스는 파일이다.

- 유닉스 커맨드에서 같은 레코드 분리자를 사용해 표준화했기 때문에 이 모든 프로그램이 상호 운영 가능하다. (awk, sort, uniq, head는 모두 `\n` 문자로 분리된 레코드 다룸)

- 깔끔하지 않은 경우도 있지만, 수십년이 지나도 유닉스의 동일 인터페이스는 여전히 대단함.

### 2.4 로직과 연결의 분리

- 표준 입력(stdin)과 표준 출력(stdout)

- 프로그램 실행 후 아무것도 하지 않으면 stdin은 키보드로부터 들어오고, stdout은 화면으로 출력됨.

- 셸 사용자는 유닉스 접근법으로 원하는대로 입력과 출력을 연결이 가능함. 사용가자 프로그램 입력이 어디서 들어오고 출력이 어디로 가는지 신경쓸 필요 없음 -> 느슨한 결합, 지연 바인딩, 또는 제어 반전이라고 함. (loosing coupling or late binding, inversion of control)

- 프로그램에서 입출력을 연결하는 부분을 분리하면 작은 도구로부터 큰 시스템을 구성하기 훨씬 수월하다.

- stdin & stdout 사용 시 제약사항

  - 프로그램 여러개 입력 & 출력이 필요할 때 불가능하진 않으나 까다로움.

  - 프로그램 출력을 파이프를 이용해 네트워크와 연결하지는 못한다 (netcat, curl은 예외)

### 2.5 투명성과 실험

- 유닉스 도구가 성공적인 이유 중 하나는 진행 사항 파악이 무척 쉬움.

  - 입력 파일은 일반적으로 불편 처리. 다양한 명령 옵션 사용해도 입력 파일에 손상이 전혀 없음.

  - 어느 시점이든 파이프라인 중단하고 less를 보내 원하는 형태 출력 나오는지 확인 가능. 디버깅할 때 유용하다.

  - 특정 파이프라인 단계 출력을 파일에 쓰고 그 파일을 다음 단계 입력으로 사용 가능.
    - 전체 파이프라인 다시 시작 안하고 다음 단계부터 시작 가능함.

## 3. 맵리듀스와 분산 파일 시스템

- 유닉스와 마찬가지로 불친절하고 무차별 대입 방법이지만 엄청나게 효율적인 도구.

- 입력 수정하지 않고 출력을 생산하는 것 외에 다른 부수 효과는 없음.

- 유닉스 도구는 stdin & stdout을 입출력으로 사용하는데, 맵리듀스는 분산 파일 시스템 상의 파일을 입출력으로 사용함.

  - 하둡에선 이 파일 시스템을 HDFS, 구글 파일 시스템 (GFS, Google File System)을 재구현한 오픈소스임.

  - HDFS는 비공유 원칙을 기반으로 하는데, NAS (Network Attached Storage)와 SAN(Storage Area Network) 아키텍처에서 사용하는 공유 디스크 방식과는 반대다.

    - 공유 디스크 저장소는 중앙 집중 저장 장치를 사용하는데 맞춤형 하드웨어를 사용하거나 파이버 채널과 같은 특별한 네트워크 인프라를 사용하기도함.

    - 비공유 방식은 특별한 하드웨어 필요 없고, 일반적인 데이터센터 네트워크에 연결된 컴퓨터면 충분함.

- HDFS는 각 장비에서 실행되는 데몬 프로세스로 구성.

  - 해당 프로세스가 다른 노드의 해당 장비에 저장된 파일에 접근할 수 있게끔 네트워크 서비스 제공.

  - 네임노드라고 부르는 중앙 서버가 특정 파일 블록이 어떤 장비에 저장됐는지 추적함.

  - 개념적으로 HDFS는 매우 큰 하나의 파일 시스템이고, 데몬이 실행 중인 모든 장비의 디스크 사용 가능함.

  - RAID와 유사함. 파일 블록을 여러 파일에 복제.

### 3.1 맵리듀스 작업 실행하기
